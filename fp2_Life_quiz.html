<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FP2級（3級含） 〇×完全攻略（全120問）</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-bottom: 30px; }
        
        /* メニュー画面 */
        .menu-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px; }
        .menu-btn { padding: 20px; border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: left; position: relative; }
        .menu-btn:hover { transform: translateY(-2px); opacity: 0.95; }
        .menu-desc { font-size: 0.85em; font-weight: normal; display: block; margin-top: 5px; opacity: 0.9; }
        .menu-badge { position: absolute; right: 20px; top: 20px; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 20px; font-size: 0.8em; }

        .btn-random { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-all { background: linear-gradient(135deg, #e67e22, #d35400); }
        .btn-weak { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

        /* クイズ画面 */
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; color: #7f8c8d; background: #ecf0f1; padding: 10px; border-radius: 8px; }
        .question-box { font-size: 1.25em; font-weight: bold; margin: 30px 0; min-height: 100px; padding: 0 10px; }
        .source-tag { display: inline-block; background: #e0f7fa; color: #006064; padding: 5px 10px; border-radius: 4px; font-size: 0.85em; margin-bottom: 10px; font-weight: bold; }
        
        .options { display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; }
        .ans-btn { padding: 15px 50px; font-size: 1.5em; border: none; border-radius: 50px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; width: 120px; }
        .btn-o { background-color: #27ae60; box-shadow: 0 4px #1e8449; }
        .btn-x { background-color: #c0392b; box-shadow: 0 4px #922b21; }
        .ans-btn:active { transform: translateY(4px); box-shadow: none; }

        .result-area { margin-top: 20px; padding: 20px; border-radius: 8px; display: none; animation: fadeIn 0.3s; }
        .correct-msg { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .incorrect-msg { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .explanation { margin-top: 15px; font-size: 1em; }
        .citation { display: block; margin-top: 10px; font-size: 0.85em; color: #555; text-align: right; font-style: italic; }
        
        .btn-next { background-color: #34495e; color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin-top: 20px; display: none; }
        
        /* 結果・設定 */
        .final-score { text-align: center; display: none; }
        .score-number { font-size: 4em; color: #e67e22; font-weight: bold; margin: 20px 0; }
        .history-control { margin-top: 40px; text-align: center; padding-top: 20px; border-top: 1px solid #eee; }
        .btn-reset { background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>FP試験 〇×完全攻略（全120問）</h1>
    
    <!-- スタート画面 -->
    <div id="start-screen">
        <p style="text-align:center; margin-bottom:20px; font-weight:bold;">コースを選択してください</p>
        <div class="menu-grid">
            <button class="menu-btn btn-random" onclick="startQuiz('random')">
                ランダムテスト
                <span class="menu-desc">全120問からランダムに30問出題</span>
            </button>
            <button class="menu-btn btn-all" onclick="startQuiz('conquest')">
                全問制覇コース
                <span class="menu-desc">未正解の問題から最大30問出題</span>
                <span class="menu-badge" id="badge-conquest">残120問</span>
            </button>
            <button class="menu-btn btn-weak" onclick="startQuiz('weak')">
                弱点克服コース
                <span class="menu-desc">間違えた問題を優先して最大30問出題</span>
                <span class="menu-badge" id="badge-weak">対象0問</span>
            </button>
        </div>
        <div class="history-control">
            <p id="history-status">進捗状況：読込中...</p>
            <button class="btn-reset" onclick="resetHistory()">学習履歴をリセットする</button>
        </div>
    </div>

    <!-- クイズ画面 -->
    <div id="quiz-interface" style="display: none;">
        <div class="status-bar">
            <span id="mode-display">モード</span>
            <span id="progress-text">残り: - 問</span>
        </div>
        
        <div class="source-tag" id="source-name">分野名</div>
        <div class="question-box" id="question-text"></div>

        <div class="options" id="options-area">
            <button class="ans-btn btn-o" onclick="checkAnswer(true)">〇</button>
            <button class="ans-btn btn-x" onclick="checkAnswer(false)">×</button>
        </div>

        <div class="result-area" id="result-feedback">
            <h3 id="result-title"></h3>
            <div id="result-explanation" class="explanation"></div>
            <span class="citation" id="result-citation"></span>
            <button class="btn-next" id="next-btn" onclick="nextQuestion()">次の問題へ</button>
        </div>
    </div>

    <!-- 終了画面 -->
    <div class="final-score" id="final-screen">
        <h2>セッション終了</h2>
        <p>今回の正解数</p>
        <div class="score-number" id="final-score-display">0 / 0</div>
        <p id="final-comment"></p>
        <button class="menu-btn btn-random" style="width:100%; margin-top:20px; text-align:center;" onclick="location.reload()">メニューに戻る</button>
    </div>
</div>

<script>
    // === 問題データ（全120問） ===
    const questionData = [
        // Source 1: 倫理・法規 (20問)
        { id: "s1_01", cat: "倫理・法規", q: "弁護士資格を持たないFPが、報酬を得なければ具体的な法律事務を行っても弁護士法に抵触しない。", a: false, exp: "有償・無償に関係なく、弁護士でなければ法律業務を行ってはなりません。", ref: "[1],[2]" },
        { id: "s1_02", cat: "倫理・法規", q: "税理士資格を持たないFPが、顧客の具体的な数値に基づいて確定申告書を作成するのは税理士法違反である。", a: true, exp: "具体的な税務相談や税務書類の作成は、税理士の独占業務です。", ref: "[1]" },
        { id: "s1_03", cat: "倫理・法規", q: "FPが「仮定の事例」に基づいて一般的な税額計算の仕組みを解説することは、税理士法に抵触しない。", a: true, exp: "一般論や架空の事例に基づく解説は可能です。", ref: "[2]" },
        { id: "s1_04", cat: "倫理・法規", q: "官公庁が公開している統計データを、引用元を明記した上でプランニング資料に使用することは著作権法上認められている。", a: true, exp: "国や官公庁のデータの引用は基本的に可能であり、引用元の明記がマナーです。", ref: "[2],[3]" },
        { id: "s1_05", cat: "倫理・法規", q: "マイナンバーは、顧客の同意があれば、FPが自由に収集・保管して管理することができる。", a: false, exp: "マイナンバーは法律で限定的に明記された場合（税や社会保障等）を除き、利用・保管できません。", ref: "[3]" },
        { id: "s1_06", cat: "倫理・法規", q: "顧客の利益よりもFP自身の利益を優先させることは職業倫理に反するが、違法ではないため許容される。", a: false, exp: "「顧客利益の優先」はFPの職業倫理の基本であり、絶対に行ってはいけません。", ref: "[1]" },
        { id: "s1_07", cat: "倫理・法規", q: "金融商品取引業者の登録を受けていないFPが、顧客と投資一任契約を結ぶことはできない。", a: true, exp: "投資一任契約や具体的な投資助言は、金融商品取引業者の登録が必要です。", ref: "[1]" },
        { id: "s1_08", cat: "倫理・法規", q: "社会保険労務士でないFPが、公的年金の一般的な仕組みを説明することは社労士法違反となる。", a: false, exp: "一般的な制度の説明であれば、資格がなくても可能です。", ref: "[2]" },
        { id: "s1_09", cat: "倫理・法規", q: "アカウンタビリティ（説明義務）は、顧客がプラン内容を理解し納得して選択するために重要である。", a: true, exp: "顧客が理解できないと不信感に繋がるため、説明義務は重要です。", ref: "[1]" },
        { id: "s1_10", cat: "倫理・法規", q: "保険募集人の登録を受けていないFPが、具体的な保険商品の勧誘・販売を行うことは禁止されている。", a: true, exp: "保険の募集・勧誘・販売を行うには保険募集人の登録が必要です。", ref: "[1]" },
        { id: "s1_11", cat: "倫理・法規", q: "FPは顧客の情報を守秘する義務があるが、顧客の同意があれば第三者に開示できる。", a: true, exp: "守秘義務は原則ですが、正当な理由や顧客の同意があれば開示可能です。", ref: "[4]" },
        { id: "s1_12", cat: "倫理・法規", q: "市販の書籍を著作権者に無断でコピーして、セミナー資料として大量配布することは著作権法違反である。", a: true, exp: "他人の著作物を承諾なしにコピーすることはできません。", ref: "[2]" },
        { id: "s1_13", cat: "倫理・法規", q: "マイナンバーは10桁の番号である。", a: false, exp: "マイナンバーは12桁です（法人番号は13桁）。", ref: "[3]" },
        { id: "s1_14", cat: "倫理・法規", q: "コンプライアンス（法令遵守）はFPが遵守すべき職業倫理の一つである。", a: true, exp: "法令遵守はFPの4つの職業倫理の1つです。", ref: "[4]" },
        { id: "s1_15", cat: "倫理・法規", q: "税理士法に違反する行為は、無償であれば行ってもよい。", a: false, exp: "有償・無償に関わらず、独占業務を資格なしで行ってはいけません。", ref: "[2]" },
        { id: "s1_16", cat: "倫理・法規", q: "顧客のライフデザインを聞かずに、資金面だけでプランニングを行うのが正しいFPの姿である。", a: false, exp: "顧客の価値観（ライフデザイン）に基づいた設計が必要です。", ref: "[5]" },
        { id: "s1_17", cat: "倫理・法規", q: "金融商品の一般的な説明や景気動向の解説は、資格がなくても可能である。", a: true, exp: "一般論の説明は可能ですが、投資判断に係る助言はできません。", ref: "[2]" },
        { id: "s1_18", cat: "倫理・法規", q: "マイナンバーカードには、健康保険証としての機能を持たせることができる。", a: true, exp: "マイナ保険証としての利用が進められています。", ref: "[3]" },
        { id: "s1_19", cat: "倫理・法規", q: "顧客への説明義務において、顧客が理解できない専門用語を多用しても問題ない。", a: false, exp: "顧客が理解できるように説明する必要があります。", ref: "[1]" },
        { id: "s1_20", cat: "倫理・法規", q: "FP業務において、関連法規（弁護士法、税理士法など）を知らなかったとしても免責される。", a: false, exp: "法令遵守はFPの義務であり、知らなかったでは済まされません。", ref: "[1]" },

        // Source 2: ライフプラン・係数 (20問)
        { id: "s2_01", cat: "ライフプラン", q: "ライフプランニングとは、ライフデザインに基づき経済的な面を中心とした生涯設計を行うことである。", a: true, exp: "価値観（ライフデザイン）に基づき、お金の面からプランを立てることです。", ref: "[5]" },
        { id: "s2_02", cat: "ライフプラン", q: "人生の三大資金とは、「教育資金」「住宅購入資金」「老後資金」のことである。", a: true, exp: "これらは人生で特にお金がかかるため、三大資金と呼ばれます。", ref: "[6]" },
        { id: "s2_03", cat: "ライフプラン", q: "キャッシュフロー表の「年間収支」には、額面の年収をそのまま記入する。", a: false, exp: "年間収支には「可処分所得（手取り金額）」を記入するのが一般的です。", ref: "[7]" },
        { id: "s2_04", cat: "ライフプラン", q: "個人のバランスシートにおいて、「純資産」は「資産合計 － 負債合計」で算出される。", a: true, exp: "資産から負債を引いた差額が純資産となります。", ref: "[7]" },
        { id: "s2_05", cat: "ライフプラン", q: "バランスシートの作成において、資産の価値は購入時の価格（取得原価）で記入する。", a: false, exp: "バランスシートは作成時点の価格（時価評価額）で記入します。", ref: "[7]" },
        { id: "s2_06", cat: "ライフプラン", q: "現在の手元資金を複利運用した場合、将来いくらになるかを計算するには「終価係数」を使用する。", a: true, exp: "元本が将来いくらになるか求めるには終価係数を使います。", ref: "[8]" },
        { id: "s2_07", cat: "ライフプラン", q: "将来の目標金額を達成するために、現在いくらの元本が必要かを計算するには「現価係数」を使用する。", a: true, exp: "将来の額から現在の元本を逆算するのは現価係数です。", ref: "[8]" },
        { id: "s2_08", cat: "ライフプラン", q: "住宅ローンの毎月の返済額を計算する際に使用する係数は「資本回収係数」である。", a: true, exp: "借入額から毎回の返済額を求めるには資本回収係数を使います。", ref: "[9]" },
        { id: "s2_09", cat: "ライフプラン", q: "老後資金として30年後に2000万円を貯めたい場合、毎年いくら積み立てるべきか計算するには「減債基金係数」を使用する。", a: true, exp: "将来の目標額から毎年の積立額を求めるのは減債基金係数です。", ref: "[9]" },
        { id: "s2_10", cat: "ライフプラン", q: "毎年一定額を受け取るために、現在いくらの元本が必要かを計算するのは「年金終価係数」である。", a: false, exp: "元本（原資）を計算するのは「年金現価係数」です。年金終価係数は積立の将来額計算です。", ref: "[8]" },
        { id: "s2_11", cat: "ライフプラン", q: "可処分所得は、年収から社会保険料と所得税・住民税を差し引いて計算する。", a: true, exp: "いわゆる手取り金額の計算式です。", ref: "[7]" },
        { id: "s2_12", cat: "ライフプラン", q: "キャッシュフロー表を作成する際、物価上昇率や変動率は考慮しないのが一般的である。", a: false, exp: "物価上昇や金利に合わせて変動率を加味するのが一般的です。", ref: "[7]" },
        { id: "s2_13", cat: "ライフプラン", q: "ライフイベント表は、将来の出来事を時系列に並べて表にしたものである。", a: true, exp: "家族の年齢や予定イベントを時系列で整理した表です。", ref: "[6]" },
        { id: "s2_14", cat: "ライフプラン", q: "「100万円を年利3%で10年運用したらいくら？」という計算には資本回収係数を使う。", a: false, exp: "これは「終価係数」を使います。", ref: "[8]" },
        { id: "s2_15", cat: "ライフプラン", q: "バランスシートの左側には「負債」、右側には「資産」を記入する。", a: false, exp: "左側に資産、右側に負債と純資産を記入します。", ref: "[7]" },
        { id: "s2_16", cat: "ライフプラン", q: "ライフデザインとは、個々人の価値観に応じた生き方の構想のことである。", a: true, exp: "どのような人生を送りたいかという価値観や構想のことです。", ref: "[5]" },
        { id: "s2_17", cat: "ライフプラン", q: "年金現価係数は、将来の一定期間、毎年一定額を受け取るための原資を計算する係数である。", a: true, exp: "取り崩し受取のための元本計算に使います。", ref: "[8]" },
        { id: "s2_18", cat: "ライフプラン", q: "教育資金は人生の三大資金には含まれない。", a: false, exp: "教育資金、住宅購入資金、老後資金が三大資金です。", ref: "[6]" },
        { id: "s2_19", cat: "ライフプラン", q: "キャッシュフロー表において、貯蓄残高がマイナスになることは許容される。", a: false, exp: "マイナスになる場合は家計が破綻しているため、プランの見直しが必要です。", ref: "[7]" },
        { id: "s2_20", cat: "ライフプラン", q: "資本回収係数は、年金の受取額計算だけでなく、住宅ローンの返済額計算にも使える。", a: true, exp: "元本を取り崩す（または返済する）場合の毎回の額を求める係数として共通です。", ref: "[9]" },

        // Source 3: 社会保険 (20問)
        { id: "s3_01", cat: "社会保険", q: "健康保険の被扶養者になるための年収要件は、原則として130万円未満である。", a: true, exp: "いわゆる「130万円の壁」です。60歳以上等は180万円未満です。", ref: "[10]" },
        { id: "s3_02", cat: "社会保険", q: "健康保険の標準報酬月額は1等級から50等級まで区分されている。", a: true, exp: "健康保険は50等級、厚生年金は32等級です。", ref: "[11]" },
        { id: "s3_03", cat: "社会保険", q: "傷病手当金は、業務上の事由による病気やケガの場合に支給される。", a: false, exp: "傷病手当金は「業務外」が対象です。業務上は労災保険がカバーします。", ref: "[12]" },
        { id: "s3_04", cat: "社会保険", q: "傷病手当金の支給を受けるには、連続して3日以上休業し、4日目からが対象となる。", a: true, exp: "「待機期間3日」を経て、4日目から支給されます。", ref: "[13]" },
        { id: "s3_05", cat: "社会保険", q: "国民健康保険には「被扶養者」の制度があり、専業主婦は保険料を払う必要がない。", a: false, exp: "国民健康保険には被扶養者の概念はなく、全員が被保険者となります。", ref: "[14]" },
        { id: "s3_06", cat: "社会保険", q: "介護保険の第2号被保険者（40歳以上65歳未満）は、原因を問わず要介護状態になれば給付を受けられる。", a: false, exp: "第2号は「老化を原因とする特定疾病」の場合のみ給付対象です。", ref: "[15]" },
        { id: "s3_07", cat: "社会保険", q: "労災保険の保険料は、事業主と労働者が折半して負担する。", a: false, exp: "労災保険料は「全額事業主負担」です。", ref: "[16]" },
        { id: "s3_08", cat: "社会保険", q: "雇用保険の基本手当について、自己都合退職の場合、給付制限期間がある。", a: true, exp: "自己都合退職の場合は、待機期間に加え給付制限期間があります。", ref: "[17]" },
        { id: "s3_09", cat: "社会保険", q: "育児休業給付金は、休業開始から180日までは賃金の67%が支給される。", a: true, exp: "最初の6ヶ月は67%、それ以降は50%です。", ref: "[18]" },
        { id: "s3_10", cat: "社会保険", q: "健康保険の任意継続被保険者となる申請期限は、退職日の翌日から20日以内である。", a: true, exp: "20日以内の申請が必要です。", ref: "[19]" },
        { id: "s3_11", cat: "社会保険", q: "協会けんぽの保険料は労使折半である。", a: true, exp: "協会けんぽは折半ですが、組合健保は規約により事業主負担を増やせます。", ref: "[11]" },
        { id: "s3_12", cat: "社会保険", q: "出産育児一時金の支給額は、原則として児1人につき50万円である。", a: true, exp: "現在は50万円支給されます。", ref: "[13]" },
        { id: "s3_13", cat: "社会保険", q: "75歳以上の者は、原則として後期高齢者医療制度の被保険者となる。", a: true, exp: "75歳以上、または65歳以上の障害認定者は後期高齢者医療制度に移行します。", ref: "[14]" },
        { id: "s3_14", cat: "社会保険", q: "介護保険の第1号被保険者は65歳以上の者である。", a: true, exp: "65歳以上が第1号、40歳以上65歳未満が第2号です。", ref: "[15]" },
        { id: "s3_15", cat: "社会保険", q: "高額療養費制度における自己負担限度額は、所得に関わらず一律である。", a: false, exp: "所得区分によって自己負担限度額は異なります。", ref: "[12]" },
        { id: "s3_16", cat: "社会保険", q: "雇用保険の適用除外となるのは、法人の役員や個人事業主などである。", a: true, exp: "これらは労働者ではないため対象外です。", ref: "[20]" },
        { id: "s3_17", cat: "社会保険", q: "傷病手当金の支給期間は、支給開始日から通算して1年6ヶ月である。", a: true, exp: "同じ疾病であれば通算して1年6ヶ月支給されます。", ref: "[13]" },
        { id: "s3_18", cat: "社会保険", q: "雇用保険の一般教育訓練給付金は、教育訓練経費の20%（上限10万円）が支給される。", a: true, exp: "一般教育訓練給付は20%、上限10万円です。", ref: "[21]" },
        { id: "s3_19", cat: "社会保険", q: "産前産後休業期間中の健康保険料は免除されない。", a: false, exp: "産前産後および育児休業期間中は、保険料が免除されます。", ref: "[18]" },
        { id: "s3_20", cat: "社会保険", q: "労災保険の通勤災害の治療費には、一部自己負担がある。", a: false, exp: "労災保険の療養給付では自己負担はありません（全額支給）。", ref: "[16]" },

        // Source 4: 公的年金 (20問)
        { id: "s4_01", cat: "公的年金", q: "国民年金の第3号被保険者は、自ら保険料を納付する必要がある。", a: false, exp: "第3号（扶養配偶者）は第2号の制度全体で負担するため、個別の納付は不要です。", ref: "[22]" },
        { id: "s4_02", cat: "公的年金", q: "老齢基礎年金の受給資格期間は、最低10年以上必要である。", a: true, exp: "以前は25年でしたが、現在は10年以上に短縮されています。", ref: "[23]" },
        { id: "s4_03", cat: "公的年金", q: "老齢基礎年金の満額受給には、40年（480ヶ月）の納付期間が必要である。", a: true, exp: "20歳から60歳までの40年間全期間納付で満額となります。", ref: "[24]" },
        { id: "s4_04", cat: "公的年金", q: "老齢基礎年金と老齢厚生年金は、必ず同時に繰下げ受給しなければならない。", a: false, exp: "繰下げは個別に選択可能です（繰上げは原則同時）。", ref: "[25]" },
        { id: "s4_05", cat: "公的年金", q: "障害基礎年金の等級は1級から3級まである。", a: false, exp: "障害基礎年金は1級・2級のみ。3級があるのは障害厚生年金です。", ref: "[26]" },
        { id: "s4_06", cat: "公的年金", q: "遺族基礎年金を受給できる遺族は、「子のある配偶者」または「子」に限られる。", a: true, exp: "子のない配偶者には遺族基礎年金は支給されません。", ref: "[27]" },
        { id: "s4_07", cat: "公的年金", q: "厚生年金保険料の料率は18.3%で固定されており、労使折半である。", a: true, exp: "18.3%固定で、会社と労働者が半分ずつ負担します。", ref: "[23]" },
        { id: "s4_08", cat: "公的年金", q: "加給年金は、厚生年金の被保険者期間が20年以上ある場合などに加算される。", a: true, exp: "原則20年以上の期間が必要です。配偶者や子がいる場合に加算されます。", ref: "[28]" },
        { id: "s4_09", cat: "公的年金", q: "中高齢寡婦加算は、遺族基礎年金をもらえない40歳以上の妻（要件あり）に加算される制度である。", a: true, exp: "子がいない妻などの救済措置として遺族厚生年金に加算されます。", ref: "[29]" },
        { id: "s4_10", cat: "公的年金", q: "離婚時の年金分割（3号分割）は、相手の合意がなくても請求できる。", a: true, exp: "3号分割は相手の合意不要で1/2分割を請求できます。", ref: "[25]" },
        { id: "s4_11", cat: "公的年金", q: "日本の公的年金は「二階建て構造」である。", a: true, exp: "1階が国民年金（基礎年金）、2階が厚生年金です。", ref: "[30]" },
        { id: "s4_12", cat: "公的年金", q: "国民年金保険料の納付期限は、翌月末である。", a: true, exp: "対象月の翌月末までに納付します。", ref: "[22]" },
        { id: "s4_13", cat: "公的年金", q: "老齢年金を繰上げ受給すると、年金額は一生涯減額される。", a: true, exp: "一度繰上げると、減額率は一生変わりません（0.4%/月）。", ref: "[31]" },
        { id: "s4_14", cat: "公的年金", q: "障害厚生年金は、初診日に国民年金の被保険者であった場合に支給される。", a: false, exp: "初診日に「厚生年金」の被保険者である必要があります。", ref: "[26]" },
        { id: "s4_15", cat: "公的年金", q: "遺族厚生年金の額は、死亡した人の老齢厚生年金（報酬比例部分）の4分の3である。", a: true, exp: "報酬比例部分の3/4が支給されます。", ref: "[29]" },
        { id: "s4_16", cat: "公的年金", q: "付加年金は、月額400円を納付することで、将来の年金額を増やせる制度である。", a: true, exp: "200円×納付月数が年額に加算されます。", ref: "[31]" },
        { id: "s4_17", cat: "公的年金", q: "在職老齢年金では、賃金と年金の合計が月額50万円を超えると調整が入る。", a: true, exp: "50万円を超えると、超えた額の半額が停止されます。", ref: "[25]" },
        { id: "s4_18", cat: "公的年金", q: "学生納付特例期間は、受給資格期間には含まれるが、年金額には反映されない。", a: true, exp: "追納しない限り年金額は増えません。", ref: "[32]" },
        { id: "s4_19", cat: "公的年金", q: "特別支給の老齢厚生年金は、生年月日に関わらず60歳から全員支給される。", a: false, exp: "生年月日により受給開始年齢が引き上げられており、対象外の人もいます。", ref: "[33]" },
        { id: "s4_20", cat: "公的年金", q: "寡婦年金と死亡一時金は、両方同時に受け取ることができる。", a: false, exp: "どちらか一方の選択となります。", ref: "[34]" },

        // Source 5: 企業年金・税金 (20問)
        { id: "s5_01", cat: "企業年金・税", q: "iDeCoの掛金は、全額が所得控除の対象となる。", a: true, exp: "小規模企業共済等掛金控除として全額控除され、節税効果があります。", ref: "[35]" },
        { id: "s5_02", cat: "企業年金・税", q: "国民年金第1号被保険者のiDeCoの掛金上限額は、月額68,000円である。", a: true, exp: "国民年金基金と合算して月額68,000円が上限です。", ref: "[36]" },
        { id: "s5_03", cat: "企業年金・税", q: "国民年金基金の1口目は、必ず「終身年金」を選択しなければならない。", a: true, exp: "1口目は終身年金（A型・B型）が必須です。", ref: "[36]" },
        { id: "s5_04", cat: "企業年金・税", q: "小規模企業共済の掛金は、月額70,000円が上限である。", a: true, exp: "1,000円から70,000円の範囲で500円刻みで設定可能です。", ref: "[37]" },
        { id: "s5_05", cat: "企業年金・税", q: "公的年金等の収入は非課税であり、確定申告の必要はない。", a: false, exp: "公的年金は「雑所得」として課税対象です（公的年金等控除あり）。", ref: "[35]" },
        { id: "s5_06", cat: "企業年金・税", q: "障害年金および遺族年金は、所得税の非課税所得である。", a: true, exp: "これらは社会政策上の配慮から非課税とされています。", ref: "[35]" },
        { id: "s5_07", cat: "企業年金・税", q: "中小企業退職金共済（中退共）の掛金は、全額を事業主が負担する。", a: true, exp: "従業員の負担はなく、全額事業主負担です。", ref: "[37]" },
        { id: "s5_08", cat: "企業年金・税", q: "確定拠出年金（DC）において、運用成果によって将来の受取額が変動する。", a: true, exp: "拠出額が決まっており、運用結果で給付額が変わります。", ref: "[38]" },
        { id: "s5_09", cat: "企業年金・税", q: "専業主婦（第3号被保険者）は、iDeCoに加入することができない。", a: false, exp: "現在は専業主婦も月額23,000円を上限に加入可能です。", ref: "[38]" },
        { id: "s5_10", cat: "企業年金・税", q: "年金を受け取る権利（受給権）は、5年で時効にかかる。", a: true, exp: "5年前まで遡って請求可能ですが、それ以前は時効となります。", ref: "[35]" },
        { id: "s5_11", cat: "企業年金・税", q: "厚生年金基金は、現在も新規設立が可能である。", a: false, exp: "平成26年以降新設できず、他の制度への移行が進んでいます。", ref: "[39]" },
        { id: "s5_12", cat: "企業年金・税", q: "確定給付企業年金（DB）は、将来の給付額が約束されている。", a: true, exp: "給付内容が確定しているのがDBの特徴です。", ref: "[39]" },
        { id: "s5_13", cat: "企業年金・税", q: "企業型DCのマッチング拠出では、事業主掛金を超えて従業員が拠出できる。", a: false, exp: "事業主掛金の範囲内でしか拠出できません。", ref: "[39]" },
        { id: "s5_14", cat: "企業年金・税", q: "iDeCoは、原則として60歳まで資産を引き出せない。", a: true, exp: "老後資金目的のため、途中引き出し制限があります。", ref: "[38]" },
        { id: "s5_15", cat: "企業年金・税", q: "iDeCoの運営主体は、各企業である。", a: false, exp: "iDeCoの運営主体は国民年金基金連合会です。", ref: "[36]" },
        { id: "s5_16", cat: "企業年金・税", q: "国民年金基金は、付加年金と同時に加入できる。", a: false, exp: "国民年金基金と付加年金は重複加入できません。", ref: "[36]" },
        { id: "s5_17", cat: "企業年金・税", q: "小規模企業共済は、会社役員も加入できる。", a: true, exp: "個人事業主だけでなく、小規模企業の役員も加入可能です。", ref: "[37]" },
        { id: "s5_18", cat: "企業年金・税", q: "ねんきん定期便は、毎年誕生月に送付される。", a: true, exp: "年金記録を確認するために毎年届きます。", ref: "[35]" },
        { id: "s5_19", cat: "企業年金・税", q: "年金の受給には裁定請求が必要である。", a: true, exp: "自動的には支払われないため、請求手続きが必要です。", ref: "[35]" },
        { id: "s5_20", cat: "企業年金・税", q: "公的年金等控除額は、年齢に関わらず一律である。", a: false, exp: "65歳未満か以上かなどで控除額が異なります。", ref: "[35]" },

        // Source 6: 資金計画・ローン (20問)
        { id: "s6_01", cat: "資金・ローン", q: "住宅ローン「フラット35」を利用する場合、保証料および保証人が必要である。", a: false, exp: "フラット35は保証人・保証料ともに不要です。", ref: "[40]" },
        { id: "s6_02", cat: "資金・ローン", q: "フラット35の融資対象となるマンションは、専有面積が30㎡以上である必要がある。", a: true, exp: "戸建ては70㎡以上、マンションは30㎡以上が要件です。", ref: "[40]" },
        { id: "s6_03", cat: "資金・ローン", q: "住宅ローンの繰上げ返済において、利息軽減効果が高いのは「返済額軽減型」である。", a: false, exp: "期間を短くする「期間短縮型」の方が、利息軽減効果は高いです。", ref: "[41]" },
        { id: "s6_04", cat: "資金・ローン", q: "住宅ローンを組む際、一般的に物件価格の20%程度の頭金を用意することが推奨される。", a: true, exp: "残金についてローンを組むのが一般的です。", ref: "[42]" },
        { id: "s6_05", cat: "資金・ローン", q: "財形住宅貯蓄は、元利合計550万円までの利子が非課税となる制度である。", a: true, exp: "財形年金貯蓄と合算して550万円まで非課税です。", ref: "[42]" },
        { id: "s6_06", cat: "資金・ローン", q: "元利均等返済は、毎回の返済額（元金＋利息）が一定になる返済方法である。", a: true, exp: "返済計画が立てやすいですが、当初は利息割合が高くなります。", ref: "[43]" },
        { id: "s6_07", cat: "資金・ローン", q: "日本学生支援機構の奨学金のうち、第1種奨学金は利息が付くタイプである。", a: false, exp: "第1種は無利子、第2種は有利子です。", ref: "[44]" },
        { id: "s6_08", cat: "資金・ローン", q: "企業が株式や社債を発行して資金調達する方法を「間接金融」という。", a: false, exp: "市場から直接調達するのは「直接金融」です。銀行借入などが間接金融です。", ref: "[45]" },
        { id: "s6_09", cat: "資金・ローン", q: "デビットカードは、利用と同時に銀行口座から代金が引き落とされるカードである。", a: true, exp: "即時決済が特徴で、原則審査もありません。", ref: "[46]" },
        { id: "s6_10", cat: "資金・ローン", q: "フラット35は、全期間固定金利の住宅ローンである。", a: true, exp: "完済まで金利が変わらないのが特徴です。", ref: "[43]" },
        { id: "s6_11", cat: "資金・ローン", q: "住宅ローンの変動金利型は、原則として半年に一回金利が見直される。", a: true, exp: "市場金利に合わせて半年ごとに見直されます。", ref: "[42]" },
        { id: "s6_12", cat: "資金・ローン", q: "元金均等返済は、返済当初の返済額が最も多く、徐々に減っていく。", a: true, exp: "元金が一定で利息が減っていくため、総返済額は元利均等より少なくなります。", ref: "[43]" },
        { id: "s6_13", cat: "資金・ローン", q: "財形住宅融資の融資限度額は、財形貯蓄残高の10倍（最大4000万円）である。", a: true, exp: "残高の10倍まで融資を受けられます。", ref: "[43]" },
        { id: "s6_14", cat: "資金・ローン", q: "フラット35の年収基準（返済負担率）は、年収400万円未満の場合は30%以下である。", a: true, exp: "400万円以上の場合は35%以下となります。", ref: "[40]" },
        { id: "s6_15", cat: "資金・ローン", q: "国の教育ローン（教育一般貸付）の融資限度額は、原則350万円である。", a: true, exp: "海外留学など一定の場合は450万円です。", ref: "[44]" },
        { id: "s6_16", cat: "資金・ローン", q: "日本学生支援機構の給付型奨学金は、返済義務がない。", a: true, exp: "給付型は返さなくて良い奨学金です。", ref: "[44]" },
        { id: "s6_17", cat: "資金・ローン", q: "ファクタリングとは、企業の売掛金を期日前に資金化する調達方法である。", a: true, exp: "売掛債権を売却して現金化する手法です。", ref: "[45]" },
        { id: "s6_18", cat: "資金・ローン", q: "クラウドファンディングは、不特定多数の人から資金を集める調達方法である。", a: true, exp: "ネットを通じて広く資金を募る方法です。", ref: "[45]" },
        { id: "s6_19", cat: "資金・ローン", q: "クレジットカードのリボ払いは、毎月の支払額を一定にするが手数料はかからない。", a: false, exp: "リボ払いは手数料（金利相当）が発生します。", ref: "[46]" },
        { id: "s6_20", cat: "資金・ローン", q: "学資保険は、契約者（親）に万一のことがあった場合、保険料払込が免除されるのが一般的だ。", a: true, exp: "親の死亡等で保険料が免除され、学資年金は予定通り受け取れます。", ref: "[41]" }
    ];

    // === システム変数 ===
    let currentQuizSet = [];
    let currentIndex = 0;
    let correctCount = 0;
    let currentMode = "";
    
    // 履歴管理（ローカルストレージ）
    function getHistory() {
        const stored = localStorage.getItem('fp2_master_history');
        return stored ? JSON.parse(stored) : {};
    }

    // 履歴保存：{ id: boolean(正解ならtrue, 不正解ならfalse) }
    function saveHistory(questionId, isCorrect) {
        const history = getHistory();
        // 一度「正解(true)」になったら、後で間違えてもtrueのまま（制覇扱い）にする場合
        // 今回は「弱点」を判定したいので、最新の結果で上書きするロジックにします。
        // ただし「全問制覇」判定のため、一度trueになったフラグは保持したいニーズもあります。
        // ここではシンプルに「最新の結果」を保存しつつ、別途「mastered」リストを持つか、
        // あるいは「一度でも正解したらtrue」方式にします。
        // ユーザー要望の「弱点克服」＝「間違えた問題」なので、
        // history[id] === true (正解済み), false (間違えた), undefined (未回答) とします。
        
        if (history[questionId] !== true) { // 既に正解済みでなければ更新
            history[questionId] = isCorrect;
        } else if (!isCorrect) {
             // 正解済みでも今回間違えたら「弱点」に戻す？
             // 一般的な「制覇」モードでは一度正解すればOKですが、
             // 復習の意味で「今回間違えたらfalse」に上書きします。
             history[questionId] = false;
        }
        
        localStorage.setItem('fp2_master_history', JSON.stringify(history));
        updateStatus();
    }

    function resetHistory() {
        if(confirm("学習履歴をすべて削除しますか？")) {
            localStorage.removeItem('fp2_master_history');
            updateStatus();
            alert("履歴をリセットしました。");
        }
    }

    function updateStatus() {
        const history = getHistory();
        const allIds = questionData.map(q => q.id);
        
        // 正解済み（制覇）数
        const masteredCount = allIds.filter(id => history[id] === true).length;
        
        // 弱点数（一度解いてfalseのもの）
        const weakCount = allIds.filter(id => history[id] === false).length;
        
        // 未回答数
        const untouchedCount = allIds.filter(id => history[id] === undefined).length;

        document.getElementById('badge-conquest').textContent = `残${120 - masteredCount}問`;
        document.getElementById('badge-weak').textContent = `対象${weakCount}問`;
        document.getElementById('history-status').textContent = `現在の進捗：正解済み ${masteredCount} / 全120問`;
    }

    // === クイズ開始処理 ===
    function startQuiz(mode) {
        currentMode = mode;
        const history = getHistory();
        let pool = [...questionData]; // 全問コピー

        if (mode === 'random') {
            // 全問からランダムに30問
            pool = shuffleArray(pool).slice(0, 30);
            document.getElementById('mode-display').textContent = "ランダムテスト (30問)";
        
        } else if (mode === 'conquest') {
            // 未正解（false または undefined）の問題のみ抽出
            pool = pool.filter(q => history[q.id] !== true);
            
            if (pool.length === 0) {
                alert("おめでとうございます！全問制覇済みです。ランダムモードで復習しましょう。");
                return;
            }
            // ランダムに並べて最大30問
            pool = shuffleArray(pool).slice(0, 30);
            document.getElementById('mode-display').textContent = `全問制覇コース (${pool.length}問)`;
        
        } else if (mode === 'weak') {
            // 間違えた問題（false）を抽出
            let weakPool = pool.filter(q => history[q.id] === false);
            
            if (weakPool.length === 0) {
                // 弱点がない場合
                if (Object.keys(history).length === 0) {
                    alert("まだ履歴がありません。まずは他のコースで学習しましょう。");
                    return;
                } else {
                    alert("現在、弱点（不正解）となっている問題はありません！");
                    return;
                }
            }
            // 最大30問
            pool = shuffleArray(weakPool).slice(0, 30);
            document.getElementById('mode-display').textContent = `弱点克服コース (${pool.length}問)`;
        }

        currentQuizSet = pool;
        currentIndex = 0;
        correctCount = 0;

        // 画面切り替え
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('quiz-interface').style.display = 'block';
        document.getElementById('final-screen').style.display = 'none';

        showQuestion();
    }

    function showQuestion() {
        const qData = currentQuizSet[currentIndex];
        document.getElementById('progress-text').textContent = `残り: ${currentQuizSet.length - currentIndex} 問`;
        document.getElementById('source-name').textContent = qData.cat;
        document.getElementById('question-text').textContent = qData.q;
        
        document.getElementById('options-area').style.display = 'flex';
        document.getElementById('result-feedback').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
    }

    function checkAnswer(userAnswer) {
        const qData = currentQuizSet[currentIndex];
        const isCorrect = (userAnswer === qData.a);
        
        // 履歴保存
        saveHistory(qData.id, isCorrect);

        const resultTitle = document.getElementById('result-title');
        const resultExp = document.getElementById('result-explanation');
        const resultRef = document.getElementById('result-citation');
        const resultBox = document.getElementById('result-feedback');

        document.getElementById('options-area').style.display = 'none';
        resultBox.style.display = 'block';
        document.getElementById('next-btn').style.display = 'block';

        if (isCorrect) {
            correctCount++;
            resultTitle.textContent = "正解！";
            resultBox.className = "result-area correct-msg";
        } else {
            resultTitle.textContent = "不正解...";
            resultBox.className = "result-area incorrect-msg";
        }

        const answerStr = qData.a ? "〇" : "×";
        resultExp.innerHTML = `<strong>正解：${answerStr}</strong><br>${qData.exp}`;
        resultRef.textContent = `出典: ${qData.ref}`;
    }

    function nextQuestion() {
        currentIndex++;
        if (currentIndex < currentQuizSet.length) {
            showQuestion();
        } else {
            showFinalResult();
        }
    }

    function showFinalResult() {
        document.getElementById('quiz-interface').style.display = 'none';
        document.getElementById('final-screen').style.display = 'block';
        
        document.getElementById('final-score-display').textContent = `${correctCount} / ${currentQuizSet.length}`;
        
        const comment = document.getElementById('final-comment');
        const percentage = (correctCount / currentQuizSet.length) * 100;
        
        if (percentage === 100) {
            comment.textContent = "満点です！完璧ですね！";
            comment.style.color = "#27ae60";
        } else if (percentage >= 80) {
            comment.textContent = "素晴らしい成績です！";
            comment.style.color = "#2980b9";
        } else {
            comment.textContent = "復習して弱点を克服しましょう。";
            comment.style.color = "#c0392b";
        }
        
        // 履歴表示更新
        updateStatus();
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // 初期化
    window.onload = updateStatus;

</script>

</body>
</html>