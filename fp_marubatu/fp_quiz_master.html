<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPè©¦é¨“ ã€‡Ã—å®Œå…¨æ”»ç•¥</title>
    <link rel="stylesheet" href="fp_quiz.css">
</head>

<body>

    <div class="container">
        <h1 id="page-title">FPè©¦é¨“<br> ã€‡Ã—å®Œå…¨æ”»ç•¥ï¼ˆå…¨120å•ï¼‰</h1>

        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="start-screen">
            <div style="text-align: left; margin-bottom: 10px;">
                <a href="index.html"
                    style="text-decoration: none; color: #7f8c8d; font-weight: bold; font-size: 1.1em;">&larr;
                    ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
            </div>
            <p style="text-align:center; margin-bottom:20px; font-weight:bold;">ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            <div class="menu-grid">
                <button class="menu-btn btn-random" onclick="startQuiz('random')">
                    ğŸ²ãƒ©ãƒ³ãƒ€ãƒ ã‚³ãƒ¼ã‚¹
                    <span class="menu-desc" id="desc-random">å…¨å•ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«30å•å‡ºé¡Œ</span>
                </button>
                <button class="menu-btn btn-all" onclick="startQuiz('conquest')">
                    ğŸ”°æœªå›ç­”ãƒ»æ–°å•ã‚³ãƒ¼ã‚¹
                    <span class="menu-desc">ã¾ã æ­£è§£ã—ã¦ã„ãªã„å•é¡Œã‹ã‚‰æœ€å¤§30å•å‡ºé¡Œ</span>
                    <span class="menu-badge" id="badge-conquest">æ®‹120å•</span>
                </button>
                <button class="menu-btn btn-weak" onclick="startQuiz('weak')">
                    ğŸ’ªå¼±ç‚¹å…‹æœã‚³ãƒ¼ã‚¹
                    <span class="menu-desc">ã„ã¾ã¾ã§ã«é–“é•ãˆãŸå•é¡Œã‚’å‡ºé¡Œ</span>
                    <span class="menu-badge" id="badge-weak">å¯¾è±¡0å•</span>
                </button>
            </div>
            <div class="history-control">
                <p id="history-status">é€²æ—çŠ¶æ³ï¼šèª­è¾¼ä¸­...</p>
                <button class="btn-reset" onclick="resetHistory()">å­¦ç¿’å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button>
            </div>
        </div>

        <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
        <div id="quiz-interface" style="display: none;">
            <div class="status-bar">
                <div style="display:flex; align-items:center;">
                    <span id="subject-icon-display" style="font-size: 1.2em; margin-right: 10px;"></span>
                    <span id="mode-display">ã‚³ãƒ¼ã‚¹</span>
                </div>
                <div>
                    <span id="progress-text">æ®‹ã‚Š: - å•</span>
                    <button class="btn-quit" onclick="quitQuiz()" style="margin-left:10px;">ä¸­æ–­ã™ã‚‹</button>
                </div>
            </div>

            <div class="source-tag" id="source-name">åˆ†é‡å</div>
            <div class="question-box" id="question-text"></div>

            <div class="options" id="options-area">
                <button class="ans-btn btn-o" onclick="checkAnswer(true)">ã€‡</button>
                <button class="ans-btn btn-x" onclick="checkAnswer(false)">Ã—</button>
            </div>

            <div class="result-area" id="result-feedback">
                <h3 id="result-title"></h3>
                <div id="result-explanation" class="explanation"></div>
                <span class="citation" id="result-citation"></span>
                <button class="btn-next" id="next-btn" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸</button>
            </div>
        </div>

        <!-- çµ‚äº†ç”»é¢ -->
        <div class="final-score" id="final-screen">
            <h2>ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†</h2>
            <p>ä»Šå›ã®æ­£è§£æ•°</p>
            <div class="score-number" id="final-score-display">0 / 0</div>
            <p id="final-comment"></p>
            <button class="menu-btn btn-random" style="width:100%; margin-top:20px; text-align:center;"
                onclick="location.reload()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
            <button class="menu-btn"
                style="width:100%; margin-top:10px; text-align:center; background-color: #95a5a6; color: white;"
                onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <!-- Script to handle dynamic loading and quiz logic -->
    <script>
        // === åˆæœŸè¨­å®šãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ ===
        const params = new URLSearchParams(window.location.search);
        const subject = params.get('subject');

        let historyKey = 'fp_master_history'; // Default
        let scriptSrc = '';
        let subjectIconChar = '';

        if (subject === 'life') {
            document.title = "FPè©¦é¨“-ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚° ã€‡Ã—å®Œå…¨æ”»ç•¥";
            subjectIconChar = 'ğŸ“…';
            document.getElementById('page-title').innerHTML = "FPè©¦é¨“-ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚° " + subjectIconChar + "<br> ã€‡Ã—å®Œå…¨æ”»ç•¥ï¼ˆå…¨120å•ï¼‰";
            historyKey = 'fp_Life_history';
            scriptSrc = 'fp_Life_questions.js';
        } else if (subject === 'finance') {
            document.title = "FPè©¦é¨“-é‡‘èè³‡ç”£é‹ç”¨ ã€‡Ã—å®Œå…¨æ”»ç•¥";
            subjectIconChar = 'ğŸ’°';
            document.getElementById('page-title').innerHTML = "FPè©¦é¨“-é‡‘èè³‡ç”£é‹ç”¨ " + subjectIconChar + "<br> ã€‡Ã—å®Œå…¨æ”»ç•¥ï¼ˆå…¨120å•ï¼‰";
            historyKey = 'fp_finance_history';
            scriptSrc = 'fp_Finance_quiz.js';
        } else if (subject === 'risk') {
            document.title = "FPè©¦é¨“-ãƒªã‚¹ã‚¯ç®¡ç† ã€‡Ã—å®Œå…¨æ”»ç•¥";
            subjectIconChar = 'ğŸ›¡ï¸';
            document.getElementById('page-title').innerHTML = "FPè©¦é¨“-ãƒªã‚¹ã‚¯ç®¡ç† " + subjectIconChar + "<br> ã€‡Ã—å®Œå…¨æ”»ç•¥ï¼ˆå…¨80å•ï¼‰";
            historyKey = 'fp_risk_history';
            scriptSrc = 'fp_Risk_quiz.js';
        } else if (subject === 'tax') {
            document.title = "FPè©¦é¨“-ã‚¿ãƒƒã‚¯ã‚¹ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚° ã€‡Ã—å®Œå…¨æ”»ç•¥";
            subjectIconChar = 'ğŸ§¾';
            document.getElementById('page-title').innerHTML = "FPè©¦é¨“-ã‚¿ãƒƒã‚¯ã‚¹ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚° " + subjectIconChar + "<br> ã€‡Ã—å®Œå…¨æ”»ç•¥ï¼ˆå…¨180å•ï¼‰";
            historyKey = 'fp_tax_history';
            scriptSrc = 'fp_Tax_quiz.js';
        } else if (subject === 'estate') {
            document.title = "FPè©¦é¨“-ä¸å‹•ç”£ ã€‡Ã—å®Œå…¨æ”»ç•¥";
            subjectIconChar = 'ğŸ¡';
            document.getElementById('page-title').innerHTML = "FPè©¦é¨“-ä¸å‹•ç”£ " + subjectIconChar + "<br> ã€‡Ã—å®Œå…¨æ”»ç•¥ï¼ˆå…¨100å•ï¼‰";
            historyKey = 'fp_estate_history';
            scriptSrc = 'fp_Estate_quiz.js';
        } else if (subject === 'inheritance') {
            document.title = "FPè©¦é¨“-ç›¸ç¶šãƒ»äº‹æ¥­æ‰¿ç¶™ ã€‡Ã—å®Œå…¨æ”»ç•¥";
            subjectIconChar = 'ğŸ“œ';
            document.getElementById('page-title').innerHTML = "FPè©¦é¨“-ç›¸ç¶šãƒ»äº‹æ¥­æ‰¿ç¶™ " + subjectIconChar + "<br> ã€‡Ã—å®Œå…¨æ”»ç•¥ï¼ˆå…¨120å•ï¼‰";
            historyKey = 'fp_inheritance_history';
            scriptSrc = 'fp_Inheritance_quiz.js';
        } else {
            // Default or Error case
            document.body.innerHTML = '<div class="container"><h1>ã‚¨ãƒ©ãƒ¼</h1><p>ç§‘ç›®ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<a href="index.html">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a></p></div>';
            throw new Error("No subject specified");
        }

        // å‹•çš„ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
        const script = document.createElement('script');
        script.src = scriptSrc;
        script.onload = () => {
            // ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
            updateStatus();
            document.getElementById('subject-icon-display').textContent = subjectIconChar;
        };
        document.body.appendChild(script);

        // === ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•° ===
        let currentQuizSet = [];
        let currentIndex = 0;
        let correctCount = 0;
        let currentMode = "";

        // å±¥æ­´ç®¡ç†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰
        function getHistory() {
            const stored = localStorage.getItem(historyKey);
            return stored ? JSON.parse(stored) : {};
        }

        function saveHistory(questionId, isCorrect) {
            const history = getHistory();

            if (history[questionId] !== true) { // æ—¢ã«æ­£è§£æ¸ˆã¿ã§ãªã‘ã‚Œã°æ›´æ–°
                history[questionId] = isCorrect;
            } else if (!isCorrect) {
                // æ­£è§£æ¸ˆã¿ã§ã‚‚ä»Šå›é–“é•ãˆãŸã‚‰ã€Œå¼±ç‚¹ã€ã«æˆ»ã™
                history[questionId] = false;
            }

            localStorage.setItem(historyKey, JSON.stringify(history));
            updateStatus();
        }

        function resetHistory() {
            if (confirm("å­¦ç¿’å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem(historyKey);
                updateStatus();
                alert("å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
            }
        }

        function updateStatus() {
            if (typeof questionData === 'undefined') return; // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‰ã‚¬ãƒ¼ãƒ‰

            const history = getHistory();
            const allIds = questionData.map(q => q.id);

            // æ­£è§£æ¸ˆã¿ï¼ˆåˆ¶è¦‡ï¼‰æ•°
            const masteredCount = allIds.filter(id => history[id] === true).length;

            // å¼±ç‚¹æ•°ï¼ˆä¸€åº¦è§£ã„ã¦falseã®ã‚‚ã®ï¼‰
            const weakCount = allIds.filter(id => history[id] === false).length;

            // æœªå›ç­”æ•°
            const untouchedCount = allIds.filter(id => history[id] === undefined).length;

            document.getElementById('badge-conquest').textContent = `æ®‹${allIds.length - masteredCount}å•`; // å…¨å•æ•°å‹•çš„å¯¾å¿œ
            document.getElementById('badge-weak').textContent = `å¯¾è±¡${weakCount}å•`;
            document.getElementById('history-status').textContent = `ç¾åœ¨ã®é€²æ—ï¼šæ­£è§£æ¸ˆã¿ ${masteredCount} / å…¨${allIds.length}å•`;

            // ãƒ©ãƒ³ãƒ€ãƒ ã‚³ãƒ¼ã‚¹ã®èª¬æ˜æ–‡ã‚‚å‹•çš„ã«æ›´æ–°
            document.getElementById('desc-random').textContent = `å…¨${allIds.length}å•ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«30å•å‡ºé¡Œ`;
        }

        // === ã‚¯ã‚¤ã‚ºé–‹å§‹å‡¦ç† ===
        function startQuiz(mode) {
            currentMode = mode;
            const history = getHistory();
            let pool = [...questionData]; // å…¨å•ã‚³ãƒ”ãƒ¼

            if (mode === 'random') {
                // å…¨å•ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«30å•
                pool = shuffleArray(pool).slice(0, 30);
                document.getElementById('mode-display').textContent = "ãƒ©ãƒ³ãƒ€ãƒ ã‚³ãƒ¼ã‚¹ (30å•)";

            } else if (mode === 'conquest') {
                // æœªæ­£è§£ï¼ˆfalse ã¾ãŸã¯ undefinedï¼‰ã®å•é¡Œã®ã¿æŠ½å‡º
                pool = pool.filter(q => history[q.id] !== true);

                if (pool.length === 0) {
                    alert("ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼å…¨å•åˆ¶è¦‡æ¸ˆã¿ã§ã™ã€‚ãƒ©ãƒ³ãƒ€ãƒ ã‚³ãƒ¼ã‚¹ã§å¾©ç¿’ã—ã¾ã—ã‚‡ã†ã€‚");
                    return;
                }
                // ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã¹ã¦æœ€å¤§30å•
                pool = shuffleArray(pool).slice(0, 30);
                document.getElementById('mode-display').textContent = `å…¨å•åˆ¶è¦‡ã‚³ãƒ¼ã‚¹ (${pool.length}å•)`;

            } else if (mode === 'weak') {
                // é–“é•ãˆãŸå•é¡Œï¼ˆfalseï¼‰ã‚’æŠ½å‡º
                let weakPool = pool.filter(q => history[q.id] === false);

                if (weakPool.length === 0) {
                    // å¼±ç‚¹ãŒãªã„å ´åˆ
                    if (Object.keys(history).length === 0) {
                        alert("ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯ä»–ã®ã‚³ãƒ¼ã‚¹ã§å­¦ç¿’ã—ã¾ã—ã‚‡ã†ã€‚");
                        return;
                    } else {
                        alert("ç¾åœ¨ã€å¼±ç‚¹ï¼ˆä¸æ­£è§£ï¼‰ã¨ãªã£ã¦ã„ã‚‹å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ï¼");
                        return;
                    }
                }

                // æœ€å¤§30å•
                pool = shuffleArray(weakPool).slice(0, 30);
                document.getElementById('mode-display').textContent = `å¼±ç‚¹å…‹æœã‚³ãƒ¼ã‚¹ (${pool.length}å•)`;
            }

            currentQuizSet = pool;
            currentIndex = 0;
            correctCount = 0;

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('quiz-interface').style.display = 'block';
            document.getElementById('final-screen').style.display = 'none';

            showQuestion();
        }

        function showQuestion() {
            const qData = currentQuizSet[currentIndex];
            document.getElementById('progress-text').textContent = `æ®‹ã‚Š: ${currentQuizSet.length - currentIndex} å•`;
            // sourceãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆï¼ˆLifeã®æ–¹ï¼‰ã¯ cat ã‚’ä½¿ã†ã€Financeã¯ source
            const category = qData.source || qData.cat;
            document.getElementById('source-name').textContent = category;
            document.getElementById('question-text').textContent = qData.q;

            document.getElementById('options-area').style.display = 'flex';
            document.getElementById('result-feedback').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
        }

        function checkAnswer(userAnswer) {
            const qData = currentQuizSet[currentIndex];
            const isCorrect = (userAnswer === qData.a);

            // å±¥æ­´ä¿å­˜
            saveHistory(qData.id, isCorrect);

            const resultTitle = document.getElementById('result-title');
            const resultExp = document.getElementById('result-explanation');
            const resultRef = document.getElementById('result-citation');
            const resultBox = document.getElementById('result-feedback');

            document.getElementById('options-area').style.display = 'none';
            resultBox.style.display = 'block';
            document.getElementById('next-btn').style.display = 'block';

            if (isCorrect) {
                correctCount++;
                resultTitle.textContent = "æ­£è§£ï¼";
                resultBox.className = "result-area correct-msg";
            } else {
                resultTitle.textContent = "ä¸æ­£è§£...";
                resultBox.className = "result-area incorrect-msg";
            }

            const answerStr = qData.a ? "ã€‡" : "Ã—";
            resultExp.innerHTML = `<strong>æ­£è§£ï¼š${answerStr}</strong><br>${qData.exp}`;
            resultRef.textContent = `å‡ºå…¸: ${qData.ref}`;
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuizSet.length) {
                showQuestion();
            } else {
                showFinalResult();
            }
        }

        function quitQuiz() {
            if (!confirm("é€”ä¸­ã§ã™ãŒãƒ†ã‚¹ãƒˆã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ")) return;

            // å›ç­”æ¸ˆã¿ã‹ã©ã†ã‹ã§åˆ†æ¯ã‚’èª¿æ•´
            // result-feedbackãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹(=å›ç­”ç›´å¾Œ)ãªã‚‰ã€ç¾åœ¨ã®å•é¡Œã‚’å«ã‚ã‚‹(currentIndex + 1)
            // ãã†ã§ãªã‘ã‚Œã°(å›ç­”å‰)ã€ç¾åœ¨ã®å•é¡Œã¯å«ã‚ãªã„(currentIndex)
            const isResultShown = document.getElementById('result-feedback').style.display === 'block';
            let attemptedCount = currentIndex;
            if (isResultShown) {
                attemptedCount = currentIndex + 1;
            }

            showFinalResult(attemptedCount);
        }

        function showFinalResult(overrideTotal) {
            document.getElementById('quiz-interface').style.display = 'none';
            document.getElementById('final-screen').style.display = 'block';

            // å¼•æ•°ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ã€ãªã‘ã‚Œã°å…¨å•æ•°
            let total = currentQuizSet.length;
            if (typeof overrideTotal === 'number') {
                total = overrideTotal;
            }

            // ä¸‡ãŒä¸€0å•ã§çµ‚äº†ã—ãŸå ´åˆ
            if (total === 0) total = 1; // 0é™¤ç®—å›é¿

            document.getElementById('final-score-display').textContent = `${correctCount} / ${total}`;

            const comment = document.getElementById('final-comment');
            const percentage = (correctCount / total) * 100;

            if (percentage === 100) {
                comment.textContent = "æº€ç‚¹ã§ã™ï¼å®Œç’§ã§ã™ã­ï¼";
                comment.style.color = "#27ae60";
            } else if (percentage >= 80) {
                comment.textContent = "ç´ æ™´ã‚‰ã—ã„æˆç¸¾ã§ã™ï¼";
                comment.style.color = "#2980b9";
            } else {
                comment.textContent = "å¾©ç¿’ã—ã¦å¼±ç‚¹ã‚’å…‹æœã—ã¾ã—ã‚‡ã†ã€‚";
                comment.style.color = "#c0392b";
            }

            // å±¥æ­´è¡¨ç¤ºæ›´æ–°
            updateStatus();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

    </script>

</body>

</html>